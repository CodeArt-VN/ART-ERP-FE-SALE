<ion-header>
	<app-toolbar [page]="this">
		<ion-button
			tollbarSelected
			title="{{ 'Create A/R invoice' | translate }}"
			*ngIf="pageConfig.ShowCopyToARInvoice && pageConfig.canAddARInvoice && selectedItems.length >= 1 && !query.IsDisabled"
			(click)="createARInvoice()"
		>
			<ion-icon color="success" slot="icon-only" name="receipt-outline"></ion-icon>
		</ion-button>

		<!-- <ion-button tollbarSelected
      title="{{ 'Create split invoice' | translate }}"
      *ngIf="pageConfig.canSplitARInvoices && selectedItems.length == 1 && !query.IsDisabled"
      (click)="createSplitARInvoices()"
    >
      <ion-icon color="success" slot="icon-only" name="git-branch"></ion-icon>
    </ion-button> -->

		<!-- <ion-button tollbarSelected
      title="{{ 'Create merged invoice' | translate }}"
      *ngIf="pageConfig.canMergeARInvoice && selectedItems.length >= 2 && !query.IsDisabled"
      (click)="createMergeARInvoice()"
    >
      <ion-icon color="success" slot="icon-only" name="git-pull-request"></ion-icon>
    </ion-button> -->
	</app-toolbar>
</ion-header>

<ion-content appScrollbarTheme class="header-table">
	<app-page-title class="ion-padding safe-max-width" [pageConfig]="pageConfig"></app-page-title>
	<ion-fab
		*ngIf="pageConfig.isShowFeature"
		style="height: 45px; z-index: 100"
		[ngClass]="{withSearch: pageConfig.isShowSearch}"
		class="feature"
		vertical="top"
		horizontal="end"
		slot="fixed"
	>
		<ion-toolbar color="primary">
			<ion-segment scrollable="true" (ionChange)="segmentView = $event.detail.value;" [value]="segmentView">
				<ion-segment-button value="s1">
					<ion-label>{{'Driver allocation' | translate}}</ion-label>
				</ion-segment-button>
				<ion-segment-button value="s2" *ngIf="pageConfig.canImportMasanSaleOrder">
					<ion-label>{{'Import order' | translate}}</ion-label>
				</ion-segment-button>
			</ion-segment>
		</ion-toolbar>
	</ion-fab>
	<ion-fab
		*ngIf="pageConfig.isShowFeature"
		style="top: -25px !important"
		[ngClass]="{withSearch: pageConfig.isShowSearch}"
		class="feature"
		vertical="top"
		horizontal="end"
		slot="fixed"
	>
		<div class="ion-padding"></div>

		<div *ngIf="segmentView=='s1'">
			<div class="ion-padding">
				<div class="c-control">
					<label class="c-label" for="DeliveryDate">{{'Ngày giao hàng' | translate}}</label>
					<input class="c-input" (change)="loadShipmentList()" id="DeliveryDate" type="date" [(ngModel)]="shipmentQuery.DeliveryDate" />
				</div>

				<div class="c-control">
					<label class="c-label" for="IDVehicle">{{'License plate' | translate}}</label>
					<ng-select
						appendTo=""
						(change)="loadShipmentList()"
						class="c-input"
						#IDVehicle
						[(ngModel)]="shipmentQuery.IDVehicle"
						labelForId="IDVehicle"
						[items]="vehicleList"
						bindLabel="Name"
						bindValue="Id"
						placeholder="{{'Search for license plate' | translate}}"
					>
						<ng-template ng-option-tmp let-i="item" let-search="searchTerm">
							<div *ngIf="i">
								<div>
									<span [ngOptionHighlight]="search">{{i.Name}}</span>
								</div>
							</div>
						</ng-template>
					</ng-select>
				</div>
			</div>

			<ion-list-header lines="full">
				<ion-label color="dark">{{'delivery list' | translate}}</ion-label>
				<ion-button size="small" title="{{'Add shipment' | translate}}" (click)="nav('shipment/0','forward', {queryParams: {shipment: shipmentQuery}})">
					<ion-icon slot="icon-only" name="add"></ion-icon>
				</ion-button>
			</ion-list-header>
			<ion-list>
				<ion-item lines="full" *ngFor="let i of shipmentList">
					<ion-label class="ion-text-wrap clickable" (click)="nav('shipment/'+i.Id,'forward')">
						<ion-text>
							<h3>{{i.ShipperName}}</h3>
						</ion-text>
						<p>
							<ion-text color="primary"> {{i.VehicleName}} </ion-text>
							{{i.DeliveryDateText}}
						</p>
					</ion-label>
					<ion-badge color="success" [ngClass]="{show: !selectedItems.length}" class="count" slot="end"
						>{{i.OrderCount}}<ion-text color="danger" *ngIf="i.DebtCount">+{{i.DebtCount}}</ion-text> đơn</ion-badge
					>
					<ion-button [disabled]="submitAttempt" color="primary" *ngIf="selectedItems.length" class="add" slot="end" (click)="addSOtoShipment(i)"
						>+ {{selectedItems.length}} {{'đơn' | translate}}</ion-button
					>
				</ion-item>
			</ion-list>

			<div class="ion-padding" *ngIf="!shipmentList.length">
				<ion-button (click)="nav('shipment/0','forward', {queryParams: {shipment: shipmentQuery}})" expand="block" shape="round" [disabled]="submitAttempt">
					{{'Add shipment' | translate}}
				</ion-button>
			</div>
		</div>

		<div *ngIf="pageConfig.canImportMasanSaleOrder && segmentView=='s2'">
			<!-- <ion-list-header lines="inset">
				<ion-label color="dark">{{'order-import-title' | translate}}</ion-label>
			</ion-list-header> -->

			<div class="ion-padding">
				<div class="c-control">
					<label class="c-label" for="featureDate">{{'Order created date' | translate}}</label>
					<input class="c-input" [(ngModel)]="masanImportParam.featureDate" id="featureDate" type="date" />
				</div>

				<div class="c-control">
					<label class="c-label" for="kho">{{'Warehouse' | translate}}</label>
					<select id="kho" [(ngModel)]="masanImportParam.wareHouse" class="c-input c-dropdown">
						<option value="KF1652T01">{{'long-thanh' | translate}}</option>
						<option value="KF1652">{{'xuan-loc' | translate}}</option>
					</select>
				</div>

				<div class="c-control">
					<ion-button [disabled]="submitAttempt" color="primary" expand="block" (click)="masanImport()"> {{'Import Masan order' | translate}}</ion-button>
					<!-- shape="round" -->
				</div>

				<div class="c-control">
					<ion-button [disabled]="submitAttempt" color="primary" expand="block" (click)="onClickImport()"> {{'Import file' | translate}}</ion-button>
					<input class="hide-all" #importfile2 type="file" accept=".xlsx" (change)="import2($event)" />
				</div>
				<div class="col-control"></div>
			</div>
		</div>

		<div class="ion-padding ion-margin"></div>
	</ion-fab>

	<div class="safe-max-width">
		<app-data-table
			class="box-shadow responsive"
			[rows]="items"
			[trackBy]="'Id'"
			[(selectedRows)]="selectedItems"
			[showSpinner]="pageConfig.showSpinner"
			[showFilter]="pageConfig.isShowSearch"
			[(query)]="query"
			(dataInfinite)="loadData($event)"
			(filter)="onDatatableFilter($event)"
			(sort)="onSort($event)"
			(selectedRowsChange)="showCommandBySelectedRows($event)"
		>
			<datatable-column [checkbox]="true" name=""></datatable-column>
			<datatable-column class="col-id" name="#" property="Id" [navLink]="pageConfig.pageName"></datatable-column>
			<datatable-column class="col-status" name="Status" property="Status" filterControlType="ng-select" [filterDataSource]="statusList">
				<ng-template let-i="row" datatable-cell-template>
					<ion-badge [color]="i._Status?.Color" [title]="i._Status?.Name"> {{i._Status?.Name | translate}} </ion-badge>
				</ng-template>
			</datatable-column>
			<datatable-column class="col-date" format="yyyy-MM-dd" name="Order date" property="OrderDate" filterControlType="date"> </datatable-column>
			<datatable-column class="col-name flex-break" name="Customer" property="_Customer">
				<ng-template let-i="row" datatable-cell-template>
					<span *ngIf="!i.IDParent" title="{{'View order's details' | translate}}" (click)="nav('sale-order/'+i.Id,'forward')"
						>{{i._Customer?.Name}}
						<small title="{{'Search for this customer' | translate}}" (click)="query.CustomerName='C:'+i.IDContact; pageConfig.isShowSearch=true; refresh()">
							{{i.IDContact}}
						</small>
						<a
							[href]="'#/'+'business-partner/'+i.IDContact"
							(click)="nav('business-partner/'+i.IDContact,'forward')"
							title="{{'View customers' information' | translate}}"
						>
							<ion-icon name="open-outline"></ion-icon>
						</a>
					</span>
					<small *ngIf="!i.IDParent && i._Customer?.Address" class="address">
						<ion-text color="dark">
							<span>{{i._Customer.Address.AddressLine1}}</span>
							<span *ngIf="i._Customer.Address.AddressLine2"> {{i._Customer.Address.AddressLine2}}</span>
						</ion-text>
					</small>
				</ng-template>
			</datatable-column>
			<datatable-column class="col-code" name="Sales staff" property="_Saleman">
				<ng-template let-i="row" datatable-cell-template> {{i._Saleman? i._Saleman.FullName :''}}</ng-template>
			</datatable-column>
			<datatable-column class="col-number bold" format="1.0-0" name="Total" property="TotalAfterTax"></datatable-column>
			<datatable-column class="col-code" name="Vendor code" property="Code"></datatable-column>
		</app-data-table>
	</div>

	<ion-infinite-scroll color="primary" threshold="20%" (ionInfinite)="loadData($event)" [disabled]="!pageConfig.infiniteScroll || pageConfig.isEndOfData">
		<ion-infinite-scroll-content loadingSpinner="dots"></ion-infinite-scroll-content>
	</ion-infinite-scroll>
</ion-content>
